<div class="big-picture" id="picture">
  <div class="roseay-word"><span style="color:#C00000">rose</span>ay</div>
  <div class="big-picture-text">edm radio</div>
</div>
<div class="top-banner">
  <!-- <div class="small_header_index">
    <span class="small_header_text">
      shuffle songs
    </span>
  </div> -->
  <a href="#newsong" class="submit-button" data-toggle="modal"><br>contribute song</a>
  <div class="next-song-btn clash"><div class="radio-next-text">play</div></div>
  <div class="search">
    <input id="song-search" placeholder="search artist or title">
  </div>
  <div class="current-song">No Song Playing</div>
  <span class="right-arrow-info">use "right keyboard arrow" to skip song</span>
  <!-- <div class="notifications"><div class="logo">!</div></div> -->
  <% if current_user %>
    <span id="logged_in"><%= current_user.username %></span>
    <%= link_to 'logout', session_path(current_user), method: :delete, class: 'logout' %>
  <% else %>
    <a id="login-modal" href="#login-signup" data-toggle="modal">login / join</a>
    <!-- |
    <a href="#newSessionModal" data-toggle="modal">join</a> -->
  <% end %>
  <a id="contributors-modal" href="#contributors" data-toggle="modal">contributors</a>
  <!-- <a id="faq-modal" href="#faq" data-toggle="modal">faq</a> -->
</div>
<div class="page-wrapper"> 
  <div class="left-tool-column">
    <div class="recently-listened-holder">
      <div class="recently-listened-header">
        <div class="recently-header-text">your listening history</div>
      </div>
      <div class="recently-listened-list">
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;none
      </div>
    </div>
  </div>
  <div class="left-side-wrapper">
    <div class="player-section">
      <% if @embed || @soundcloud_embed %>
        <% if @soundcloud_embed %>
          <% embed_info = @client.get('/oembed', :url => @soundcloud_embed) %>
          <%= embed_info['html'].gsub('%2F', '/').gsub('%3A', ':').gsub('<iframe ', '<iframe data-id='+@id.to_s+ ' ').html_safe %>
        <% else %>
          <iframe  width="545" height="220" src=<%="http://www.youtube.com/embed/#{@embed}?autoplay=1&controls=2&iv_load_policy=3&autohide=2&modestbranding=1&loop=1&fmt=18"%> frameborder="0" data-id="<%= @id %>"></iframe>
        <% end %>
      <% else %>
        <div class="player-holder"><span class="player-holder-text"><br><br><br>click play</span></div>
      <% end %>
    </div>
    <!-- <div class="top_header">
      <span class="about">readme</span>
    </div> -->
    <div class="below-main">
    </div>
    <!-- <div class="feed-header-holder">
      <span class="feed-title">
        <div class="big_header">
          <h1><a>Refresh Song Feed</a></h1>
        </div>
      </span>
    </div> -->

    <!-- <div id="12345" data-time="<%=@by_time%>"> -->
      <!-- <span class="pagination">
        <span class="backbtn">back</span>
        <span class="nextbtn"><a href="#nextbtn">next</a></span>
        <br><br>
      </span> -->
      <!-- <ol start="1" id="songwrap" > -->

      <!-- </ol>
      <span class="pagination"> -->
        <!-- <span class="backbtn">less</span> -->
        <!-- <span class="nextbtn"><a href="#nextbtn">more</a></span> -->
        <!-- <br><br>
      </span>
    </div> -->
  </div>  
  <div class="hidden-song"></div>
  <div class="forced-song"></div>

<!--   <div class="queue-holder">
    <div class="queue-header">your Q</div>
    <span class="queue-songs">
      &nbsp;&nbsp;&nbsp;empty
    </span>
  </div> -->

  <div class="topsongs-section">
    <div class="topsongs-holder">
    </div>
  </div>
<!--   <div class="feedback-input">
    <div class="feedback-title">Feedback/Suggestions (anonymous)</div>
    <textarea class="remark-input"></textarea>
    <button class="remark-input-btn">tell us</button>
  </div> -->

<!--   <span class="right-remarks">
    <div class="remark-section">
      <div class="remark-header">
        remarks
      </div> -->
<!--       <div class="refresh">Refresh Remark Feed</div>
      <span class="remarks">
      </span>
      <span class="pagination"><a class="next-remark-btn" data-remark-page="1" data-remark-filter>more</a></span>
      <br>
    </div>
  </span> -->

  <div class="right-side-wrapper">
    <span class="left-songlist">
      <div class="testing1" data-radio="true">
        <div class="below-player">
          <div class="other-songs-holder">
            <div class="other-songs-left-side">
              <div class="upvote-player"></div>
              <div class="player-info"></div>
            </div>
            <div class="other-songs-right-side">
            </div>
          </div>
        </div>
      </div>
    </span>
  </div>
  <div class="up-next-holder">
    <div class="up-next-header">
      up next..
    </div>
    <div class="up-next-song">
    </div>
    <div class="up-next-change">
      <div class="up-next-text">re-choose</div>
    </div>
  </div>
</div>
<%= render 'new_song_modal' %>
<%= render 'new_session_modal' %>
<%= render 'new_bump_modal' %>
<%= render 'contributors_modal' %>
<%= render 'faq_modal' %>

<script src="//connect.soundcloud.com/sdk.js"></script>
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-39171492-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
  (function(){var requirejs,require,define,__inflate;(function(e){function a(e,t){var n=t&&t.split("/"),i=r.map,s=i&&i["*"]||{},o,u,a,f,l,c,h;if(e&&e.charAt(0)==="."&&t){n=n.slice(0,n.length-1),e=n.concat(e.split("/"));for(l=0;h=e[l];l++)if(h===".")e.splice(l,1),l-=1;else if(h===".."){if(l===1&&(e[2]===".."||e[0]===".."))return!0;l>0&&(e.splice(l-1,2),l-=2)}e=e.join("/")}if((n||s)&&i){o=e.split("/");for(l=o.length;l>0;l-=1){u=o.slice(0,l).join("/");if(n)for(c=n.length;c>0;c-=1){a=i[n.slice(0,c).join("/")];if(a){a=a[u];if(a){f=a;break}}}f=f||s[u];if(f){o.splice(0,l,f),e=o.join("/");break}}}return e}function f(t,n){return function(){return u.apply(e,s.call(arguments,0).concat([t,n]))}}function l(e){return function(t){return a(t,e)}}function c(e){return function(n){t[e]=n}}function h(r){if(n.hasOwnProperty(r)){var s=n[r];delete n[r],i[r]=!0,o.apply(e,s)}if(!t.hasOwnProperty(r))throw new Error("No "+r);return t[r]}function p(e,t){var n,r,i=e.indexOf("!");return i!==-1?(n=a(e.slice(0,i),t),e=e.slice(i+1),r=h(n),r&&r.normalize?e=r.normalize(e,l(t)):e=a(e,t)):e=a(e,t),{f:n?n+"!"+e:e,n:e,p:r}}function d(e){return function(){return r&&r.config&&r.config[e]||{}}}var t={},n={},r={},i={},s=[].slice,o,u;o=function(r,s,o,u){var a=[],l,v,m,g,y,b;u=u||r,typeof o=="string"&&(o=__inflate(r,o));if(typeof o=="function"){s=!s.length&&o.length?["require","exports","module"]:s;for(b=0;b<s.length;b++){y=p(s[b],u),m=y.f;if(m==="require")a[b]=f(r);else if(m==="exports")a[b]=t[r]={},l=!0;else if(m==="module")v=a[b]={id:r,uri:"",exports:t[r],config:d(r)};else if(t.hasOwnProperty(m)||n.hasOwnProperty(m))a[b]=h(m);else if(y.p)y.p.load(y.n,f(u,!0),c(m),{}),a[b]=t[m];else if(!i[m])throw new Error(r+" missing "+m)}g=o.apply(t[r],a);if(r)if(v&&v.exports!==e&&v.exports!==t[r])t[r]=v.exports;else if(g!==e||!l)t[r]=g}else r&&(t[r]=o)},requirejs=require=u=function(t,n,i,s){return typeof t=="string"?h(p(t,n).f):(t.splice||(r=t,n.splice?(t=n,n=i,i=null):t=e),n=n||function(){},s?o(e,t,n,i):setTimeout(function(){o(e,t,n,i)},15),u)},u.config=function(e){return r=e,u},define=function(e,t,r){t.splice||(r=t,t=[]),n[e]=[e,t,r]},define.amd={jQuery:!0}})(),__inflate=function(name,src){var r;return eval(["r = function(a,b,c){","\n};\n//@ sourceURL="+name+"\n"].join(src)),r},define("lib/api/events",["require","exports","module"],function(e,t,n){t.api={LOAD_PROGRESS:"loadProgres",PLAY_PROGRESS:"playProgress",PLAY:"play",PAUSE:"pause",FINISH:"finish",SEEK:"seek",READY:"ready",OPEN_SHARE_PANEL:"sharePanelOpened",SHARE:"share",CLICK_DOWNLOAD:"downloadClicked",CLICK_BUY:"buyClicked"},t.bridge={REMOVE_LISTENER:"removeEventListener",ADD_LISTENER:"addEventListener"}}),define("lib/api/getters",["require","exports","module"],function(e,t,n){n.exports={GET_VOLUME:"getVolume",GET_DURATION:"getDuration",GET_POSITION:"getPosition",GET_SOUNDS:"getSounds",GET_CURRENT_SOUND:"getCurrentSound",GET_CURRENT_SOUND_INDEX:"getCurrentSoundIndex",IS_PAUSED:"isPaused"}}),define("lib/api/setters",["require","exports","module"],function(e,t,n){n.exports={PLAY:"play",PAUSE:"pause",TOGGLE:"toggle",SEEK_TO:"seekTo",SET_VOLUME:"setVolume",NEXT:"next",PREV:"prev",SKIP:"skip"}}),define("lib/api/api",["require","exports","module","lib/api/events","lib/api/getters","lib/api/setters"],function(e,t,n){function m(e){return!!(e===""||e&&e.charCodeAt&&e.substr)}function g(e){return!!(e&&e.constructor&&e.call&&e.apply)}function y(e){return!!e&&e.nodeType===1&&e.nodeName.toUpperCase()==="IFRAME"}function b(e){var t=!1,n;for(n in i)if(i.hasOwnProperty(n)&&i[n]===e){t=!0;break}return t}function w(e){var t,n,r;for(t=0,n=f.length;t<n;t++){r=e(f[t]);if(r===!1)break}}function E(e){var t="",n,r,i;e.substr(0,2)==="//"&&(e=window.location.protocol+e),i=e.split("/");for(n=0,r=i.length;n<r;n++){if(!(n<3))break;t+=i[n],n<2&&(t+="/")}return t}function S(e){return e.contentWindow?e.contentWindow:e.contentDocument&&"parentWindow"in e.contentDocument?e.contentDocument.parentWindow:null}function x(e){var t=[],n;for(n in e)e.hasOwnProperty(n)&&t.push(e[n]);return t}function T(e,t,n){n.callbacks[e]=n.callbacks[e]||[],n.callbacks[e].push(t)}function N(e,t){var n=!0,r;return t.callbacks[e]=[],w(function(t){r=t.callbacks[e]||[];if(r.length)return n=!1,!1}),n}function C(e,t,n){var r=S(n),i,s;if(!r.postMessage)return!1;i=n.getAttribute("src").split("?")[0],s=JSON.stringify({method:e,value:t}),i.substr(0,2)==="//"&&(i=window.location.protocol+i),i=i.replace(/http:\/\/(w|wt).soundcloud.com/,"https://$1.soundcloud.com"),r.postMessage(s,i)}function k(e){var t;return w(function(n){if(n.instance===e)return t=n,!1}),t}function L(e){var t;return w(function(n){if(S(n.element)===e)return t=n,!1}),t}function A(e,t){return function(n){var r=g(n),i=k(this),s=!r&&t?n:null,o=r&&!t?n:null;return o&&T(e,o,i),C(e,s,i.element),this}}function O(e,t,n){var r,i,s;for(r=0,i=t.length;r<i;r++)s=t[r],e[s]=A(s,n)}function M(e,t,n){return e+"?url="+t+"&"+_(n)}function _(e){var t,n,r=[];for(t in e)e.hasOwnProperty(t)&&(n=e[t],r.push(t+"="+(t==="start_track"?parseInt(n,10):n?"true":"false")));return r.join("&")}function D(e,t,n){var r=e.callbacks[t]||[],i,s;for(i=0,s=r.length;i<s;i++)r[i].apply(e.instance,n);if(b(t)||t===o.READY)e.callbacks[t]=[]}function P(e){var t,n,r,i,s;try{n=JSON.parse(e.data)}catch(u){}t=L(e.source),r=n.method,i=n.value,r===o.READY&&(t?(t.isReady=!0,D(t,l),N(l,t)):a.push(e.source)),r===o.PLAY&&!t.playEventFired&&(t.playEventFired=!0),r===o.PLAY_PROGRESS&&!t.playEventFired&&(t.playEventFired=!0,D(t,o.PLAY,[i]));if(!t||H(e.origin)!==H(t.domain))return!1;s=[],i!==undefined&&s.push(i),D(t,r,s)}function H(e){return e.replace(h,"")}var r=e("lib/api/events"),i=e("lib/api/getters"),s=e("lib/api/setters"),o=r.api,u=r.bridge,a=[],f=[],l="__LATE_BINDING__",c="http://wt.soundcloud.dev:9200/",h=/^http(?:s?)/,p,d,v;window.addEventListener?window.addEventListener("message",P,!1):window.attachEvent("onmessage",P),n.exports=v=function(e,t,n){m(e)&&(e=document.getElementById(e));if(!y(e))throw new Error("SC.Widget function should be given either iframe element or a string specifying id attribute of iframe element.");t&&(n=n||{},e.src=M(c,t,n));var r=L(S(e)),i,s;return r&&r.instance?r.instance:(i=a.indexOf(S(e))>-1,s=new p(e),f.push(new d(s,e,i)),s)},v.Events=o,window.SC=window.SC||{},window.SC.Widget=v,d=function(e,t,n){this.instance=e,this.element=t,this.domain=E(t.getAttribute("src")),this.isReady=!!n,this.callbacks={}},p=function(){},p.prototype={constructor:p,load:function(e,t){if(!e)return;t=t||{};var n=this,r=k(this),i=r.element,s=i.src,a=s.substr(0,s.indexOf("?"));r.isReady=!1,r.playEventFired=!1,i.onload=function(){n.bind(o.READY,function(){var e,n=r.callbacks;for(e in n)n.hasOwnProperty(e)&&e!==o.READY&&C(u.ADD_LISTENER,e,r.element);t.callback&&t.callback()})},i.src=M(a,e,t)},bind:function(e,t){var n=this,r=k(this);return r&&r.element&&(e===o.READY&&r.isReady?setTimeout(t,1):r.isReady?(T(e,t,r),C(u.ADD_LISTENER,e,r.element)):T(l,function(){n.bind(e,t)},r)),this},unbind:function(e){var t=k(this),n;t&&t.element&&(n=N(e,t),e!==o.READY&&n&&C(u.REMOVE_LISTENER,e,t.element))}},O(p.prototype,x(i)),O(p.prototype,x(s),!0)}),window.SC=window.SC||{},window.SC.Widget=require("lib/api/api")})();

  var player;
  function onYouTubeIframeAPIReady() {
    var num = 1;
    while (!($('#ytplayer' + num).length)){
      num ++
    }

    player = new YT.Player('ytplayer' + num, {
      height: '220',
      width: '545',
      videoId: $('.testing1').attr('data-youtube-code'),
      events: {
        'onReady': onPlayerReady,
        'onStateChange': onPlayerStateChange,
        'onError': onPlayerError
      }
    })
  }

  function onPlayerError(event){
    createPlayerErrorTooltip();
    var songPlayed = $('.testing1').attr('data-song-played');
    playNextSong(songPlayed);
    $.post('/remarks.json?fix_song='+songPlayed);
  }

  function onPlayerStateChange(event) {
    var myPlayerState;
    myPlayerState = event.data;
    if (myPlayerState == 0){
      playNextSong($('.testing1').attr('data-song-played'));
      $.post('/remarks.json?completed_song=1')
    }
  }

  function onPlayerReady(event){
    event.target.playVideo();
  }

  var playNextSong = function(id){
    if ($('.forced-song .song a').length){
      $($('.forced-song .song a')[0]).trigger('click');
      var chosenID = $($('.forced-song .song')[0]).attr('id');
      $($('.forced-song .song')[0]).remove();

      var chosenSong = false;
      $.each(songs,function(i, song){
        if (song['id'] == chosenID){
          chosenSong = song;
        }
      });

      $('.below-main').empty();
      $('.below-main').append('<br><div class="show-song-author">1 person likes this song<br>contributed by '+chosenSong['author']+'</div>')
      if (chosenSong['voted'] == 0){
        $('.below-main').append('<div class="vote-box"><br><br>liked</div>')
      } else {
        $('.below-main').append('<div class="upvote" data-path="/songs/'+chosenSong['id']+'/upvote"><br><br>like</div>')
      }
      $('.below-main').append('<div class="recently-added-tag">Recently Added</div>')
      listenedAlready.push(chosenSong);
    } else {
      $('.hidden-song').empty();
      var chosenSong = false;
      var priorityChance = Math.floor(Math.random()*6) == 0
      if (priorityChance){
        var prioritySongs = []
        $.each(songs, function(i, song){
          if (song['priority'] == 1){
            prioritySongs.push(song)
          }
        })
        if (prioritySongs.length){
          while (!(chosenSong)){
            chosenSong = prioritySongs[Math.floor(Math.random()*prioritySongs.length)]
          }
        } else {
          while (!(chosenSong)){
            chosenSong = songs[Math.floor(Math.random()*songs.length)]
          }
        }

      } else {
        while (!(chosenSong)){
          chosenSong = songs[Math.floor(Math.random()*songs.length)]
        }
      }
      if (listenedAlready.indexOf(chosenSong) == -1){
        if (chosenSong['points'] == 1){
          var personOrPeople = 'person likes'
        } else {
          var personOrPeople = 'people like'
        }
        setupHiddenSong(chosenSong)
        $('.hidden-song .song a').trigger('click');
        $('.below-main').empty();
        $('.below-main').append('<br><div class="show-song-author">'+chosenSong['points']+' '+personOrPeople+' this song<br>contributed by '+chosenSong['author']+'</div>')
        if (chosenSong['voted'] == 0){
          $('.below-main').append('<div class="vote-box"><br><br>liked</div>')
        } else {
          $('.below-main').append('<div class="upvote" data-path="/songs/'+chosenSong['id']+'/upvote"><br><br>like</div>')
        }
        listenedAlready.push(chosenSong);
        if (chosenSong['priority'] == 1){
          $('.below-main').append('<div class="recently-added-tag">Recently Added</div>')
        }
      } else {
        playNextSong(id);
      }
    }
  }

  var setupHiddenSong = function(datum){
    var songID = datum['id']
    var link = datum['song_link'].split('watch?v=')[1]
    if (link == undefined){
      var link = datum['song_link'];
    }
    $('.hidden-song').append('<li class="song" id="'+songID+'"></li>')
    $('.hidden-song .song').append('<span id="song"><a href="/songs?d='+link+'"><span class="song-artist">'+datum['song_artist']+'</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="song-name">'+datum["song_name"]+'</span></a></span>')
  }

  function calcParallax(tileheight, speedratio, scrollposition) {
    return ((tileheight) - (Math.floor(scrollposition / speedratio) % (tileheight+1)));
  }

  var createPlayerErrorTooltip = function(){
    $('body').prepend('<div class="radio-tooltip">We skipped a song for you because the video was broken. We will continue to make your listening experience smooth :)</div>')
    setTimeout(function(){
      $('.radio-tooltip').remove();
    }, 6000)
  }

  $(function() {
    $.fn.scrollBottom = function() {
        return $(document).height() - this.scrollTop() - this.height();
    };

    var $el = $('.top-banner');
    var $el2 = $('.topsongs-section');
    var $window = $(window);

    $window.bind("scroll resize", function() {
        var gap = $window.height() - $el.height() - 10;
        var visibleFoot = 400 - $window.scrollBottom();
        var scrollTop = $window.scrollTop()
        
        if(scrollTop < 400 + 10){
            $el.css({
                top: (400 - scrollTop) + "px",
                bottom: "auto"
            });
            $el2.css({
                top: (455 - scrollTop) + "px",
                bottom: "auto"
            });
        }else if (visibleFoot > gap) {
            $el.css({
                top: "auto",
                bottom: visibleFoot + "px"
            });
            $el2.css({
                top: "auto",
                bottom: visibleFoot + "px"
            });
        } else {
            $el.css({
                top: 0,
                bottom: "auto"
            });
            $el2.css({
                top: 55,
                bottom: "auto"
            });
        }
    });
    window.onscroll = function() {
      var posX = (document.documentElement.scrollLeft) ? document.documentElement.scrollLeft : window.pageXOffset;
      var posY = (document.documentElement.scrollTop) ? document.documentElement.scrollTop : window.pageYOffset;
      
      var ground = document.getElementById('picture');
      var groundparallax = 47 + ((calcParallax(50, 8, posY) / $(document).height()) * 2000);
      if (groundparallax > 100){
        groundparallax = 100;
      } else if (groundparallax < 0) {
        groundparallax = 0;
      }
      ground.style.backgroundPosition = "left "+ groundparallax+"%"; 
      if ($(window).scrollTop() + $(window).height() == $(document).height()){
        if (!(($('.nextbtn a').html() == 'exit search') || ($('.nextbtn a').html() == 'unshuffle'))){
          setTimeout(function(){
            $('.nextbtn').trigger('click')
          }, 500)
        }
      }
    }
});



</script>